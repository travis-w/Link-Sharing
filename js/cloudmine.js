(function(){function t(e){this.options=w(this,e);var t=this.options.appid;e.savelogin&&(this.options.userid||(this.options.userid=x("userid",t)),this.options.session_token||(this.options.session_token=x("session_token",t))),this.options.user_token=x("ut",t)||T("ut",b(),t)}function n(t){this.config=U({},o,t),this._events={};var i="JS/"+e,s=this.config.options;s.appname&&(i+=" "+s.appname.replace(g,"_"),s.appversion&&(i+="/"+s.appversion.replace(g,"_"))),this.additionalData=this.config.callbackData,this.data=null,this.hasErrors=!1,this.requestData=this.config.data,this.requestHeaders={"X-CloudMine-ApiKey":s.apikey,"X-CloudMine-Agent":i,"X-CloudMine-UT":s.user_token},this.responseHeaders={},this.responseText=null,this.status=null,this.type=this.config.type||"GET";var u=q(N(s,this.config.query)),a="/",f=s.session_token,l=s.applevel;if(l===!1||l!==!0&&f!=null)t.action.split("/")[0]!=="account"&&(a="/user/"),f!=null&&(this.requestHeaders["X-CloudMine-SessionToken"]=f);for(var c in this.config.headers)O(this.requestHeaders,c,this.config.headers[c]);this.config.headers=this.requestHeaders,I(r)||(this.config.headers["X-CloudMine-UT"]+=";"+q(r,":",","),r={});if(t.username||t.password)this.config.headers.Authorization="Basic "+J(t.username+":"+t.password),this.config.username=null,this.config.password=null;this.setContentType(t.contentType||"application/json"),this.url=[nt,"/v1/app/",this.config.options.appid,a,this.config.action,u?"?"+u:""].join("");var h=this,p=this.config,d=+(new Date);this.config.complete=function(e,t){var i;if(e){i=e.responseText,h.status=e.status,h.responseText=i,h.responseHeaders=R(e.getAllResponseHeaders(),/:\s*/,/(?:\r|\n)?\n/);var s=h.responseHeaders["X-Request-Id"];s&&(r[s]=+(new Date)-d);try{h.data=JSON.parse(i||"{}")}catch(o){h.data=i}}else h.status="abort",h.data=[p.data];t=="success"&&h.status>=200&&h.status<300?i=p.processResponse.call(h,h.data,e,h):(i={errors:{}},_(h.data)&&(h.data={errors:[h.data]}),i.errors[h.status]=h.data),setTimeout(function(){n.complete(h,i)},1)},!this.config.later&&this.config.async&&setTimeout(function(){h.xhr=Q(h.url,p)},1)}function i(e,t){t=t||{},this.status=400,this.responseText=[],this._headers={};var n=Z.parse(e);n.agent=!1,n.method=t.type,n.headers=t.headers||{},M(t.data)&&t.processData&&(t.data=JSON.stringify(t.data));if(t.username||t.password)n.headers.Authorization="Basic "+J(t.username+":"+t.password);H(t.data)?n.headers["content-length"]=d.byteLength(t.data):_(t.data)&&(n.headers["content-length"]=t.data.length);var r=this,i=t.context||this;this._textStatus="success",this._request=(n.protocol==="http:"?V:K).request(n,function(e){e.setEncoding(t.encoding||"utf8"),e.on("data",function(e){r.responseText.push(e)}),e.on("close",function(){e.emit("end")}),e.on("end",function(){r._headers=q(e.headers,": ","\n",!0)||"",r.status=e.statusCode;var n=r.responseText=r.responseText.join("");if(t.dataType=="json"||t.dataType!="text"&&e.headers["content-type"].match(/\bapplication\/json\b/i))try{n=JSON.parse(n)}catch(s){r._textStatus="parsererror"}r._textStatus=="success"&&r.status>=200&&r.status<300?t.success&&t.success.call(i,n,"success",r):t.error&&t.error.call(i,r,"error",r.responseText),t.complete&&t.complete.call(i,r,r._textStatus)})}),this._request.on("error",function(e){r.status=e.status,r.responseText=e.message,r._textStatus="error",t.error&&t.error.call(i,r,"error",e.message),t.complete&&t.complete.call(i,r,"error")}),this._request.end(t.data)}function y(){return Math.round(Math.random()*15).toString(16)}function b(){var e=Array(32),t;e[14]=4,e[19]=(Math.round(Math.random()*16)&3|8).toString(16);for(t=0;t<14;++t)e[t]=y();for(t=15;t<19;++t)e[t]=y();for(t=20;t<32;++t)e[t]=y();return e.join("")}function w(e,t){return U({},e.options,t)}function x(e,t){var n=et(t);return n[e]}function T(e,t,n){var r=et(n);return r[e]!=t&&(r[e]=t,tt(n)),t}function N(e,t){var n,r;t==null&&(t={});for(n in s)r=s[n],e[n]!=null&&(t[r]=e[n]);return t}function C(e,t,n){return A(e,function(e){return(!t||e[0]==t)&&(!n||n==e[1])})}function k(e,t,n){return Array.prototype.slice.call(e,t||0,n||e.length)}function L(e,t,n){n=n||this;if(H(e))if(e.forEach)e.forEach(t,n);else for(var r=0;r<e.length;++r){var i=e[r];i!=null&&t.call(n,i,s,n)}else if(M(e))for(var s in e){var i=e[s];i!=null&&t.call(n,i,s,n)}}function A(e,t,n){var r=null;return n=n||this,H(e)?e.filter?r=e.filter(t,n):(r=[],L(e,function(e,n,i){t.apply(this,arguments)&&r.push(e)})):(r={},L(e,function(e,n,i){t.apply(this,arguments)&&(r[n]=e)})),r}function O(e,t,n){if(e[t]==null){var r=t.toLowerCase();for(var i in e)if(i.toLowerCase()===r){t=i;break}}return n!==undefined&&(e[t]=n),e[t]}function M(e){return e&&typeof e=="object"}function _(e){return typeof e=="string"}function D(e){return typeof e=="number"&&!isNaN(e)}function P(e){return M(e)&&m.indexOf(e.constructor)>-1}function H(e){return e===null?!1:M(e)&&e.length!=null}function B(e){return typeof e=="function"}function j(e){return M(e)&&e.__type__==="geopoint"}function F(e,t){if(D(e)&&D(t))return{latitude:t,longitude:e};if(M(e)){if(t&&j(e[t]))return F(e[t]);var n={latitude:e.latitude||e.lat||e.y,longitude:e.longitude||e.lng||e.x};if(D(n.latitude)&&D(n.longitude))return n;for(var r in e)if(j(e[r]))return{latitude:e.latitude||e.lat||e.y,longitude:e.longitude||e.lng||e.x}}return null}function I(e){if(e)for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function q(e,t,n,r){t=t||"=";var i=[],s,o=r?X:encodeURIComponent;for(var u in e)e[u]!=null&&!B(e[u])&&(s=M(e[u])?JSON.stringify(e[u]):e[u],i.push(o(u)+t+o(s)));return i.join(n||"&")}function R(e,t,n,r){e=e.split(n||"&");var i={},s=r?X:decodeURIComponent;for(var o=0;o<e.length;++o){var u=e[o].split(t);i[s(u.shift())]=s(u.join(t))}return i}function U(e){for(var t=1;t<arguments.length;++t)L(arguments[t],function(t,n,r){t!=null&&(e[n]=t)});return e}function z(e){if(M(e)){var t=[];for(var n in e)t.push(n+" = "+JSON.stringify(e[n]));return"["+t.join(", ")+"]"}return e}function W(){throw new Error("Unsupported operation")}function X(e){return e}var e="0.9.5";t.prototype={get:function(e,t){H(e)?e=e.join(","):M(e)&&(t=e,e=null),t=w(this,t);var r=e?N(t,{keys:e}):null;return new n({action:"text",type:"GET",options:t,query:r})},update:function(e,t,r){if(M(e))r=t;else{e||(e=b());var i={};i[e]=t,e=i}return r=w(this,r),new n({action:"text",type:"POST",options:r,query:N(r),data:JSON.stringify(e)})},set:function(e,t,r){if(M(e))r=t;else{e||(e=b());var i={};i[e]=t,e=i}return r=w(this,r),new n({action:"text",type:"PUT",options:r,query:N(r),data:JSON.stringify(e)})},destroy:function(e,t){return t=w(this,t),e==null&&t.all===!0?e={all:!0}:e={keys:H(e)?e.join(","):e},new n({action:"data",type:"DELETE",options:t,query:N(t,e)})},run:function(e,t,r){return r=w(this,r),t=U({},r.params,t),r.params=null,r.snippet=null,new n({action:"run/"+e,type:r.method||"GET",query:t,options:r})},search:function(e,t){return t=w(this,t),e={q:e!=null?z(e):""},new n({action:"search",type:"GET",query:N(t,e),options:t})},searchFiles:function(e,t){e=z(e);var n='[__type__ = "file"';return!e||e.replace(/\s+/,"").length==0?n+="]":e[0]!="["?n+="]."+e:n+=(e[1]=="]"?"":", ")+e.substring(1),this.search(n,t)},searchUsers:function(e,t){return e={p:e!=null?z(e):""},t=w(this,t),new n({action:"account/search",type:"GET",query:N(t,e),options:t})},allUsers:function(e){return e=w(this,e),new n({action:"account",type:"GET",query:N(e,""),options:e})},getUser:function(e,t){return t=w(this,t),new n({action:"account/"+e,type:"GET",query:N(t,""),options:t})},searchGeo:function(e,t,n,r){var i,r;M(t)?(r=n||{},i=F(t,e)):(r||(r={}),i=F(t,n));if(!i)throw new TypeError("Parameters given do not provide geolocation data");var s=r.radius;D(s)?s=", "+s+(r&&r.units?r.units:"km"):_(s)&&s.length?(s=", "+s,r.units||(r.units=s.match(/mi?|km|ft/)[0])):s="";var o=(e||"location")+" near ("+i.longitude+", "+i.latitude+")"+s;return this.search("["+o+"]",r)},upload:function(e,t,r){function s(e,t){r.contentType||(r.contentType=t||l),n.binaryUpload(i,e,r.filename,r.contentType).done()}r=w(this,r),e||(e=b()),r.filename||(r.filename=e);var i=new n({action:"binary/"+e,type:"post",later:!0,encoding:"binary",options:r,processResponse:n.basicResponse});if(_(t)||d&&t instanceof d)G?(_(t)&&(t=Y.readFileSync(t)),s(t)):W();else if(t.toDataURL)s(t,"image/png");else if(v&&t instanceof v)s(t.canvas,"image/png");else if(P(t)){var o=new h;o.onabort=function(){i.setData("FileReader aborted").abort()},o.onerror=function(e){i.setData(e.target.error).abort()},o.onload=function(e){s(e.target.result)},c&&t instanceof c?!r.contentType&&t.type!=""&&(r.contentType=t.type):t=new Blob([new Uint8Array(t)],{type:r.contentType||l}),o.readAsDataURL(t)}else W();return i},download:function(e,t){t=w(this,t);var r={success:{}},i;t.filename&&(i={force_download:!0,apikey:t.apikey,session_token:t.session_token,filename:t.filename});var s=new n({action:"binary/"+e,type:"GET",later:!0,encoding:"binary",options:t,query:i});if(t.filename){if(G)s.setProcessor(function(n){return r.success[e]=Y.writeFileSync(t.filename,n,"binary"),r}).done();else{function o(){u.parentNode&&document.body.removeChild(u)}var u=document.createElement("iframe");u.style.display="none",document.body.appendChild(u),setTimeout(function(){u.src=s.url},25),u.onload=function(){clearTimeout(o.timer),o.timer=setTimeout(o,5e3)},o.timer=setTimeout(o,6e4),r.success[e]=u}s.done(r)}else t.mode==="buffer"&&(p||d)?s.setProcessor(function(t){var n;if(d)n=new d(t,"binary");else{n=new p(t.length);var i=new Uint8Array(n);for(var s=0;s<t.length;++s)i[s]=t[s]&255}return r.success[e]=n,r}).done():s.setProcessor(function(t){return r.success[e]=t,r}).done();return s},createUser:function(e,t,r){M(e)?r=t:e={userid:e,password:t},r=w(this,r),r.applevel=!0;var i=JSON.stringify({credentials:{email:e.userid,password:e.password},profile:r.profile});return new n({action:"account/create",type:"POST",options:r,processResponse:n.basicResponse,data:i})},updateUser:function(e,t,r){if(M(e))r=t;else{var i={};i[e]=t,e=i}return r=w(this,r),new n({action:"account",type:"POST",options:r,query:N(r),data:JSON.stringify(e)})},changePassword:function(e,t,r,i){M(e)?i=t:e={userid:e,oldpassword:t,password:r},i=w(this,i),i.applevel=!0;var s=JSON.stringify({password:e.password});return new n({action:"account/password/change",type:"POST",data:s,options:i,processResponse:n.basicResponse,username:e.userid,password:e.oldpassword})},resetPassword:function(e,t){t=w(this,t),t.applevel=!0;var r=JSON.stringify({email:e});return new n({action:"account/password/reset",type:"POST",options:t,processResponse:n.basicResponse,data:r})},confirmReset:function(e,t,r){r=w(this,r),r.applevel=!0;var i=JSON.stringify({password:t});return new n({action:"account/password/reset/"+e,type:"POST",data:i,processResponse:n.basicResponse,options:r})},login:function(e,t,r){M(e)?r=t:e={userid:e,password:t},r=w(this,r),r.applevel=!0,this.options.userid=null,this.options.session_token=null,r.savelogin&&(T("userid",null,this.options.appid),T("session_token",null,this.options.appid));var i=this;return(new n({action:"account/login",type:"POST",options:r,username:e.userid,password:e.password,processResponse:n.basicResponse})).on("success",function(t){r.savelogin&&(T("userid",e.userid,i.options.appid),T("session_token",t.session_token,i.options.appid)),i.options.userid=e.userid,i.options.session_token=t.session_token})},loginSocial:function(e,t){function a(){u.closed&&(clearTimeout(a.interval),s.done())}G&&W(),t=w(this,t),t.applevel=!0;var r=b(),i=this,s=new n({action:"account/social/login/status/"+r,options:t,later:!0,processResponse:function(e){return e.finished?(i.options.session_token=e.session_token,e={success:e}):(i.options.session_token=null,e={errors:["Login unsuccessful."]}),t.savelogin&&T("session_token",i.options.session_token,i.options.appid),e}}),o=nt+"/v1/app/"+t.appid+"/account/social/login?service="+e+"&apikey="+t.apikey+"&challenge="+r;this.options.session_token&&t.link!==!1&&(o+="&session_token="+this.options.session_token);var u=window.open(o,r,"width=600,height=400,menubar=0,location=0,toolbar=0,status=0");return a.interval=setInterval(a,50),s},logout:function(e){e=w(this,e),e.applevel=!0;var t=this.options.session_token;return this.options.userid=null,this.options.session_token=null,e.savelogin&&(T("userid",null,this.options.appid),T("session_token",this.options.appid)),new n({action:"account/logout",type:"POST",processResponse:n.basicResponse,headers:{"X-CloudMine-SessionToken":t},options:e})},verify:function(e,t,r){return M(e)?w=t:e={userid:e,password:t},r=w(this,r),r.applevel=!0,new n({action:"account/login",type:"POST",processResponse:n.basicResponse,username:e.userid,password:e.password,options:r})},deleteUser:function(e,t,r){M(e)?r=t:e={userid:e,password:t},r=w(this,r),r.applevel=!0;var i={action:"account",type:"DELETE",options:r,processResponse:n.basicResponse};return e.userid==this.options.userid&&(this.options.session_token=null,this.options.userid=null,r.savelogin&&(T("userid",null,this.options.appid),T("session_token",null,this.options.appid))),e.password?(i.username=e.userid,i.password=e.password):i.action+="/"+e.userid,new n(i)},isLoggedIn:function(){return!!this.options.session_token},getUserID:function(){return this.options.userid},getSessionToken:function(){return this.options.session_token},getOption:function(e){return s[e]?this.options[e]:null},setOption:function(e,t){return s[e]?(this.options[e]=t,!0):!1},useApplicationData:function(e){this.options.applevel=e===!0||e===!1?e:undefined},isApplicationData:function(){return this.options.applevel===!0||this.options.applevel===!1?this.options.applevel:this.options.session_token==null}},t.VERSION=e,t.SocialNetworks=["bodymedia","dropbox","facebook","fitbit","flickr","foursquare","gcontacts","gdocs","github","gmail","google","gplus","instagram","linkedin","meetup","runkeeper","tumblr","twitter","withings","wordpress","yammer","zeo"],n.prototype={on:function(e,t,n){if(B(t)){n=n||this,this._events[e]||(this._events[e]=[]);var r=this;this._events[e].push([t,n,function(){r.off(e,t,n),t.apply(this,arguments)}])}return this},trigger:function(e){var t=this._events[e];if(t!=null){var n=k(arguments,1);L(t,function(e){e[2].apply(e[1],n)})}return this},off:function(e,t,n){return e==null&&t==null&&n==null?this._events={}:e==null?L(this._events,function(e,r,i){i._events[r]=C(e,t,n)}):this._events[e]=C(this._events[e],t,n),this},setContentType:function(e){return e=e||l,this.config&&(this.config.contentType=e,O(this.requestHeaders,"content-type",e),O(this.config.headers,"content-type",e)),this},abort:function(){return this.xhr?this.xhr.abort():this.config&&this.config.complete.call(this,this.xhr,"abort"),this.xhr&&(this.xhr=undefined,delete this.xhr),this.config&&(this.config=undefined,delete this.config),this},setData:function(e){return!this.xhr&&this.config&&(this.config.data=e),this},setProcessor:function(e){return!this.xhr&&this.config&&(this.config.processResponse=e),this},done:function(e){if(!this.xhr&&this.config)if(e){this.xhr=!0;var t=this;setTimeout(function(){n.complete(t,e)},1)}else this.xhr=Q(this.url,this.config);return this},getHeader:function(e){return O(this.responseHeaders,e)}},n.complete=function(e,t){t.errors&&(e.hasErrors=!0),e.config&&(e.config=undefined,delete e.config),e.xhr&&(e.xhr=undefined,delete e.xhr),t.success&&(u[e.status]&&e.trigger(u[e.status],t.success,e,e.status),e.trigger(e.status,t.success,e,e.status),e.trigger("success",t.success,e)),t.meta&&e.trigger("meta",t.meta,e),t.result&&e.trigger("result",t.result,e);if(t.errors){for(var n in t.errors)u[n]&&e.trigger(u[n],t.errors[n],e,n),e.trigger(n,t.errors[n],e,n);e.trigger("error",t.errors,e)}e.trigger("complete",t,e)},n.textResponse=function(e,t,n){var r={};if(e.success||e.errors||e.meta||e.result){e.count!=null&&(n.count=e.count),I(e.success)||(r.success=e.success),I(e.meta)||(r.meta=e.meta),I(e.result)||(r.result=e.result);if(!I(e.errors)){r.errors={};for(var i in e.errors){var s=e.errors[i],o=400;s.code?(o=s.code,s=s.message||s):_(s)&&(o=a[s.toLowerCase()]||400),r.errors[o]||(r.errors[o]={}),r.errors[o][i]={errors:[s]}}}I(r)&&(this.config.options&&this.config.options.snippet?r.result={}:r.success={})}else r={success:e};return r},n.basicResponse=function(e,t,n){return{success:e||{}}},n.binaryUpload=function(e,t,n,r){var i=b();return d&&t instanceof d?(t=t.toString("base64"),r||(r=l)):(t.toDataURL&&(t=t.toDataURL(r)),t=t.replace(/^data:(.*?);?base64,/,""),r||(r=RegExp.$1||l)),e.setContentType("multipart/form-data; boundary="+i),e.setData(["--"+i,'Content-Disposition: form-data; name="file"; filename="'+n+'"',"Content-Type: "+r,"Content-Transfer-Encoding: base64","",t,"--"+i+"--"].join("\r\n"))};var r={};i.prototype={getResponseHeader:function(e){return this._headers[e]},getAllResponseHeaders:function(){return this._headers},abort:function(){this._request&&(this._textStatus="abort",this._request.abort(),this._request=undefined,delete this._request)}};var s={limit:"limit",sort:"sort",skip:"skip",snippet:"f",params:"params",dontwait:"async",resultsonly:"result_only",count:"count",distance:"distance",units:"units"},o={async:!0,later:!1,processData:!1,dataType:"text",processResponse:n.textResponse,crossDomain:!0,cache:!1},u={200:"ok",201:"created",400:"badrequest",401:"unauthorized",404:"notfound",409:"conflict",500:"servererror"},a={"bad request":400,"permission denied":401,unauthorized:401,"key does not exist":404,"not found":404,conflict:409},f=this.window?window:root,l="application/octet-stream",c=f.File,h=f.FileReader,p=f.ArrayBuffer,d=f.Buffer,v=f.CanvasRenderingContext2D,m=[c,d,v,p,f.Uint8Array,f.Uint8ClampedArray,f.Uint16Array,f.Uint32Array,f.Int8Array,f.Int16Array,f.Int32Array,f.Float32Array,f.Float64Array],g=/[^a-zA-Z0-9._-]/g,E={},S="base",V,J,K,Q,G,Y,Z,et,tt,nt="https://api.cloudmine.me";if(!this.window)G=!0,Z=require("url"),V=require("http"),K=require("https"),Y=require("fs"),module.exports={WebService:t},Q=function(e,t){return new i(e,t)},J=function(e,t){return(new d(e,t||"utf8")).toString("base64")},et=function(e){e="cm."+(e||S);if(!E[e]){var t=[".",process.env.HOME+"/."],n;while((n=t.shift())!=null)try{E[e]=JSON.parse(Y.readFileSync(n+e+".json","UTF8"));break}catch(r){}n||(E[e]={})}return E[e]},tt=function(e){e="cm."+(e||S);var t=[".",process.env.HOME+"/."],n;while((n=t.shift())!=null)try{Y.writeFileSync(n+e+".json",JSON.stringify(E[e]||{}),"UTF8");break}catch(r){}if(!n)throw new Error("Could not save CloudMine session data")};else{G=!1,window.cloudmine=window.cloudmine||{},window.cloudmine.WebService=t,J=window.btoa,window.cloudmine.API&&(nt=window.cloudmine.API);if(($=this.jQuery||this.Zepto)==null)throw new Error("Missing jQuery-compatible ajax implementation");Q=$.ajax,$.support&&($.support.cors=!0),et=function(e){e="cm."+(e||S);if(!E[e])try{E[e]=JSON.parse(localStorage.getItem(e))||{}}catch(t){E[e]={}}return E[e]},tt=function(e){e="cm."+(e||S),localStorage.setItem(e,JSON.stringify(E[e]||{}))}}})()